---
/**
 * Custom Sidebar Component
 * Extends Starlight's default sidebar with expand/collapse all buttons,
 * What's New link, and Popular badge injection
 */
import type { Props } from '@astrojs/starlight/props';
import Default from '@astrojs/starlight/components/Sidebar.astro';
import popularityData from '../data/popularity.json';

// Get popular paths for client-side badge injection
const popularPaths = popularityData.topPages?.slice(0, 5).map((p: { path: string }) => p.path) ?? [];
---

<div class="sidebar-header">
  <a href="/changelog/" class="whats-new-link">
    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 8v4l3 3"/>
      <circle cx="12" cy="12" r="10"/>
    </svg>
    <span>What's New</span>
    <span class="new-dot"></span>
  </a>

  <div class="sidebar-controls">
    <button type="button" class="sidebar-control-btn" id="expand-all" title="Expand all sections">
      <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="7 13 12 18 17 13"/>
        <polyline points="7 6 12 11 17 6"/>
      </svg>
    </button>
    <button type="button" class="sidebar-control-btn" id="collapse-all" title="Collapse all sections">
      <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="17 11 12 6 7 11"/>
        <polyline points="17 18 12 13 7 18"/>
      </svg>
    </button>
  </div>
</div>

<Default {...Astro.props}><slot /></Default>

<!-- Pass popular paths to client-side script -->
<script define:vars={{ popularPaths }}>
  function initSidebarControls() {
    const expandBtn = document.getElementById('expand-all');
    const collapseBtn = document.getElementById('collapse-all');

    if (!expandBtn || !collapseBtn) return;

    expandBtn.addEventListener('click', () => {
      const groups = document.querySelectorAll('.sidebar-pane details, nav[aria-label="Main"] details');
      groups.forEach((group) => {
        group.setAttribute('open', '');
      });
    });

    collapseBtn.addEventListener('click', () => {
      const groups = document.querySelectorAll('.sidebar-pane details, nav[aria-label="Main"] details');
      groups.forEach((group) => {
        group.removeAttribute('open');
      });
    });
  }

  function injectPopularBadges() {
    if (!popularPaths || popularPaths.length === 0) return;

    // Find sidebar links matching popular paths
    const sidebarLinks = document.querySelectorAll('.sidebar-pane a, nav[aria-label="Main"] a');

    sidebarLinks.forEach((link) => {
      const href = link.getAttribute('href');
      if (!href) return;

      // Normalize href to match popularity data format
      const normalizedHref = href.replace(/\/$/, '') || '/';

      if (popularPaths.includes(normalizedHref)) {
        // Check if badge already exists (from frontmatter)
        if (link.querySelector('.sl-badge, .popular-badge')) return;

        // Create and append popular badge
        const badge = document.createElement('span');
        badge.className = 'popular-badge';
        badge.textContent = 'Popular';
        badge.title = 'Frequently visited page';
        link.appendChild(badge);
      }
    });
  }

  initSidebarControls();
  injectPopularBadges();
  document.addEventListener('astro:page-load', () => {
    initSidebarControls();
    injectPopularBadges();
  });
</script>

<style>
  .sidebar-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    margin-bottom: 0.25rem;
    border-bottom: 1px solid var(--sl-color-hairline-light);
  }

  .whats-new-link {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.375rem 0.625rem;
    background: rgba(99, 91, 255, 0.08);
    border: 1px solid rgba(99, 91, 255, 0.15);
    border-radius: 6px;
    color: var(--sl-color-text);
    font-size: 0.75rem;
    font-weight: 500;
    text-decoration: none;
    transition: all 0.15s ease;
  }

  .whats-new-link:hover {
    background: rgba(99, 91, 255, 0.15);
    border-color: var(--sl-color-accent);
  }

  .whats-new-link svg {
    color: var(--sl-color-accent);
  }

  .new-dot {
    width: 6px;
    height: 6px;
    background: linear-gradient(135deg, #10B981, #34D399);
    border-radius: 50%;
    animation: pulse-dot 2s ease-in-out infinite;
  }

  @keyframes pulse-dot {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.6; transform: scale(1.2); }
  }

  .sidebar-controls {
    display: flex;
    gap: 0.25rem;
  }

  .sidebar-control-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    background: transparent;
    border: 1px solid var(--sl-color-hairline);
    border-radius: 6px;
    color: var(--sl-color-gray-3);
    cursor: pointer;
    transition: all 0.15s ease;
  }

  .sidebar-control-btn:hover {
    background: rgba(99, 91, 255, 0.08);
    border-color: var(--sl-color-accent);
    color: var(--sl-color-accent);
  }

  .sidebar-control-btn:active {
    transform: scale(0.95);
  }

  /* Popular badge styling */
  :global(.popular-badge) {
    display: inline-block;
    font-size: 0.5625rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.025em;
    padding: 0.125rem 0.375rem;
    margin-left: 0.375rem;
    background: linear-gradient(135deg, rgba(255, 128, 181, 0.15), rgba(255, 128, 181, 0.1));
    color: #ff80b5;
    border: 1px solid rgba(255, 128, 181, 0.25);
    border-radius: 4px;
    vertical-align: middle;
  }

  :root[data-theme='light'] :global(.popular-badge) {
    background: linear-gradient(135deg, rgba(236, 72, 153, 0.1), rgba(236, 72, 153, 0.05));
    color: #db2777;
    border-color: rgba(236, 72, 153, 0.2);
  }
</style>
