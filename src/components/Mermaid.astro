---
/**
 * Mermaid diagram component
 * Usage in MDX:
 * <Mermaid>
 * graph TD
 *   A[Start] --> B[End]
 * </Mermaid>
 */

interface Props {
  title?: string;
}

const { title } = Astro.props;
---

<figure class="mermaid-wrapper">
  {title && <figcaption class="mermaid-title">{title}</figcaption>}
  <div class="mermaid">
    <slot />
  </div>
</figure>

<script>
  // Load Mermaid from CDN
  const initMermaid = async () => {
    if (typeof window !== 'undefined' && !window.mermaid) {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js';
      script.onload = () => {
        window.mermaid.initialize({
          startOnLoad: true,
          theme: document.documentElement.dataset.theme === 'light' ? 'default' : 'dark',
          securityLevel: 'loose',
          fontFamily: 'system-ui, -apple-system, sans-serif',
        });
        window.mermaid.run();
      };
      document.head.appendChild(script);
    } else if (window.mermaid) {
      window.mermaid.run();
    }
  };

  // Run on page load and navigation
  initMermaid();
  document.addEventListener('astro:page-load', initMermaid);

  // Re-render on theme change
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.attributeName === 'data-theme' && window.mermaid) {
        const theme = document.documentElement.dataset.theme === 'light' ? 'default' : 'dark';
        window.mermaid.initialize({ theme });
        window.mermaid.run();
      }
    });
  });
  observer.observe(document.documentElement, { attributes: true });
</script>

<style>
  .mermaid-wrapper {
    margin: 1.5rem 0;
    padding: 1.5rem;
    background: var(--sl-color-bg-nav);
    border: 1px solid var(--sl-color-hairline);
    border-radius: 0.5rem;
    overflow-x: auto;
  }

  .mermaid-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--sl-color-gray-3);
    margin-bottom: 1rem;
    text-align: center;
  }

  .mermaid {
    display: flex;
    justify-content: center;
  }

  .mermaid :global(svg) {
    max-width: 100%;
    height: auto;
  }
</style>
